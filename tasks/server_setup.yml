- name: Check for test server
  shell: |
    lxc-attach -n {{ utility_container.stdout }}  \
    -- bash -c '. /root/openrc ; \
    openstack server list | grep "{{ test_server }}"'
  register: test_server_instance
  changed_when: false
  failed_when: false

- name: Delete test server
  shell: |
    lxc-attach -n {{ utility_container.stdout }}  \
    -- bash -c '. /root/openrc ; \
    openstack server delete "{{ test_server }}"'
  when: test_server_instance.rc == 0

- name: Create test server
  shell: |
    lxc-attach -n {{ utility_container.stdout }} \
    -- bash -c '. /root/openrc ; \
    openstack server create \
    -f json \
    --image "{{ image.name }}" \
    --flavor "{{ flavor.name }}" \
    --nic net-id="PRIVATE_NET" \
    --key-name "rpc_support" \
    "{{ test_server }}"'
