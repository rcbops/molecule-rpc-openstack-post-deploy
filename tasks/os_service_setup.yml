---
# Clone openstack-ansible-ops to infra host and execute
# openstack-service-setup playbook.

- name: Clean old openstack-ansible-ops dir if previously existing
  file:
    state: absent
    path: /opt/openstack-ansible-ops

- name: Clone openstack-ansible-ops repo
  git:
    repo: https://github.com/openstack/openstack-ansible-ops.git
    dest: /opt/openstack-ansible-ops

- name: Run openstack-service-setup
  shell: |
    openstack-ansible openstack-service-setup.yml
  args:
    executable: /bin/bash
    chdir: /opt/openstack-ansible-ops/multi-node-aio-xenial-ansible/playbooks/
  async: 2700
  poll: 60

- name: install custom fact for service setup
  copy:
    content: "{{ {'already_ran':'true'} | to_nice_json(indent=2) }}"
    dest: "{{ custom_fact_path }}/service_setup.fact"

- name: re-read facts after adding custome fact
  setup: filter=ansible_local
